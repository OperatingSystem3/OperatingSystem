# lab 4 进程管理

#### 小组成员：徐亚民，肖胜杰，张天歌

## 练习1：分配并初始化一个进程控制块

### 编程实现

```
// 初始化进程的状态为 PROC_UNINIT，表示该进程尚未初始化完成
proc->state = PROC_UNINIT;
// 初始化进程ID为 -1，表示未分配有效进程ID
proc->pid = -1;
// 进程的运行次数初始化为 0，表示进程尚未运行
proc->runs = 0;
// 内核栈初始化为 0，表示该进程的内核栈尚未分配
proc->kstack = 0;
// 设置进程需要重新调度的标志为 0，表示当前不需要调度
proc->need_resched = 0;
// 初始化进程的父进程为 NULL，表示没有父进程（通常是 init 进程）
proc->parent = NULL;
// 进程的内存管理结构体 (mm_struct) 初始化为 NULL，表示没有内存管理信息
proc->mm = NULL;
// 将进程的上下文 (context) 清零，为了保证没有遗留的状态
memset(&(proc->context), 0, sizeof(struct context));
// 初始化进程的陷阱帧 (trapframe) 为 NULL，表示该进程还没有陷入中断或系统调用
proc->tf = NULL;
// 设置进程的 CR3 寄存器为 boot_cr3，通常是系统启动时的页目录表基地址
proc->cr3 = boot_cr3;
// 初始化进程的标志位为 0，表示没有特殊的进程标志
proc->flags = 0;
// 清空进程名称的字符串，确保没有随机的字符，长度为 PROC_NAME_LEN + 1
memset(proc->name, 0, PROC_NAME_LEN + 1);
```

### `struct context context` 和 `struct trapframe *tf` 的作用

在 `proc_struct` 结构体中，`struct context context` 和 `struct trapframe *tf` 都是与进程调度和上下文切换相关的关键字段。它们分别代表进程切换时的寄存器保存和中断/系统调用时的状态保存。以下是对这两个成员变量的详细解释和它们在实验中的作用。

#### 1. `struct context context`

`context` 结构体用于保存进程上下文，特别是在进行进程切换时，需要保存和恢复的寄存器值。它包含了进程的所有重要寄存器状态，以便操作系统能够在进程切换时保存当前进程的状态，并恢复另一个进程的状态，从而实现多任务处理。

- **保存进程的寄存器状态：** 当操作系统需要切换当前执行的进程时，它会将当前进程的寄存器（如通用寄存器、程序计数器等）保存到 `context` 中，并加载新的进程的寄存器状态来继续执行。
- **进程切换时恢复状态：** 在进行进程切换时（例如，由调度程序选择了一个新的进程来执行），操作系统会使用 `context` 中保存的寄存器值恢复新进程的状态，确保新进程从正确的位置继续执行。

在一个简单的操作系统中，进程切换是通过保存和恢复上下文来实现的。当一个进程被抢占或发生调度时，操作系统会将当前进程的状态保存到 `context` 结构中，然后从新进程的 `context` 结构中恢复它的寄存器状态。这是进行任务切换的核心机制。

#### 2. `struct trapframe *tf`

`trapframe` 是用于保存进程在中断或异常发生时的状态信息的数据结构。它主要保存了进程在发生中断、系统调用或者异常时的寄存器状态。每当进程在内核模式下进入系统调用或发生中断时，都会将寄存器状态保存到一个 `trapframe` 结构体中。

- **保存中断或异常的状态：** 当进程从用户态切换到内核态（比如发生系统调用或中断），CPU 会将一些关键的寄存器（如程序计数器、堆栈指针等）保存到 `trapframe` 中。这样操作系统就能知道在处理中断或系统调用时，如何恢复原进程的执行状态。
- **系统调用的上下文保存：** 在发生系统调用时，操作系统需要保存当前进程的状态，以便处理完系统调用后能够恢复执行。而 `trapframe` 就是保存这些状态的地方。

在本实验中，当进程执行系统调用、触发中断或异常时，操作系统会创建一个 `trapframe`，并将当前进程的寄存器状态保存在其中。这个结构在进程从用户态切换到内核态时发挥重要作用。当内核处理完中断或系统调用后，会恢复 `trapframe` 中保存的寄存器状态，从而继续执行原进程。

#### 总结：
- **`struct context context`** 主要用于保存进程的上下文（即寄存器状态）以便在进程切换时能够恢复执行。
- **`struct trapframe *tf`** 主要用于保存进程在中断或系统调用过程中需要保存的状态，特别是在进程从用户态切换到内核态时。

在实验中，`context` 用于支持进程间的调度和上下文切换，而 `trapframe` 用于保存和恢复进程在发生中断、异常或系统调用时的状态。两者配合使用，确保进程切换和系统调用的上下文能够正确保存和恢复。

## 练习2：为新创建的内核线程分配资源（需要编码）

## 练习3：编写proc_run 函数（需要编码）

## 扩展练习 Challenge：